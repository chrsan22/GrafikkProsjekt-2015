<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - fly controls - earth</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background:#000;
            color: #eee;
            padding:0;
            margin:0;
            font-weight:bold;
            overflow:hidden;

            font-family:Monospace;
            font-size:13px;
            text-align:center;
        }

        #info {
            position: absolute;
            top: 0px; width: 100%;
            padding: 5px;
            z-index:100;
        }

        a {

            color: #0080ff;
        }

        b { color:orange }
    </style>

    <script src="scripts/three.min.js"></script>

    <script src="camera/FlyControls/FlyControls.js"></script>

    <script src="camera/FlyControls/CopyShader.js"></script>
    <script src="camera/FlyControls/FilmShader.js"></script>

    <script src="camera/FlyControls/EffectComposer.js"></script>
    <script src="camera/FlyControls/ShaderPass.js"></script>
    <script src="camera/FlyControls/MaskPass.js"></script>
    <script src="camera/FlyControls/RenderPass.js"></script>
    <script src="camera/FlyControls/FilmPass.js"></script>

</head>

<body>

<div id="info"><br/>
    <b>WASD</b> move, <b>R|F</b> up | down, <b>Q|E</b> roll, <b>up|down</b> pitch, <b>left|right</b> yaw<br/>
</div>

<script>

    var radius = 6371;
    var tilt = 0.41;
    //Planet rotation
    var rotationSpeed = 0.1;

    var MARGIN = 0;
    var SCREEN_HEIGHT = window.innerHeight - MARGIN * 2;
    var SCREEN_WIDTH  = window.innerWidth;

    var container;
    var camera, controls, scene, renderer;
    var geometry, meshPlanet;
    var dirLight;

    var d, dPlanet = new THREE.Vector3();

    var clock = new THREE.Clock();

    init();
    animate();

    function init() {

        container = document.createElement( 'div' );
        document.body.appendChild( container );

        camera = new THREE.PerspectiveCamera( 25, SCREEN_WIDTH / SCREEN_HEIGHT, 50, 1e7 );
        // Camera posisjon ut fra radius til planetene
        camera.position.z = radius * 5;

        scene = new THREE.Scene();

        controls = new THREE.FlyControls( camera );
        // WASD speed
        controls.movementSpeed = 1000;
        controls.domElement = container;
        // Rollspeed for Q og E rollen
        controls.rollSpeed = Math.PI / 24;

        // For å bevege mousemovement bare når tasten er nede
        controls.dragToLook = true;

        // Lyset som gis
        dirLight = new THREE.DirectionalLight( 0xffffff );
        dirLight.position.set( -1, 0, 1 ).normalize();
        scene.add( dirLight );


        var materialNormalMap = new THREE.MeshPhongMaterial( {
            specular: 0x333333,
            shininess: 15,
            map: THREE.ImageUtils.loadTexture( "camera/FlyControls/earth_atmos_2048.jpg" ),
            specularMap: THREE.ImageUtils.loadTexture( "camera/FlyControls/earth_specular_2048.jpg" ),
            normalMap: THREE.ImageUtils.loadTexture( "camera/FlyControls/earth_normal_2048.jpg" ),
            normalScale: new THREE.Vector2( 0.85, 0.85 )

        } );

        // planet

        geometry = new THREE.SphereGeometry( radius, 100, 50 );

        meshPlanet = new THREE.Mesh( geometry, materialNormalMap );
        meshPlanet.rotation.y = 0;
        meshPlanet.rotation.z = tilt;
        scene.add( meshPlanet );

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

//        renderer.sortObjects = false;
//        renderer.autoClear = false;

        container.appendChild( renderer.domElement );

        window.addEventListener( 'resize', onWindowResize, false );

        // postprocessing

        var renderModel = new THREE.RenderPass( scene, camera );
        var effectFilm = new THREE.FilmPass( 0.35, 0.75, 2048, false );

        effectFilm.renderToScreen = true;

        composer = new THREE.EffectComposer( renderer );

        composer.addPass( renderModel );
        composer.addPass( effectFilm );

    }

    function onWindowResize( event ) {

        SCREEN_HEIGHT = window.innerHeight;
        SCREEN_WIDTH  = window.innerWidth;

        renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

        camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
        camera.updateProjectionMatrix();

        composer.reset();

    }

    function animate() {

        requestAnimationFrame( animate );

        render();
    }

    function render() {
        // rotate the planet and clouds
        var delta = clock.getDelta();

        // slow down as we approach the surface
        dPlanet = camera.position.length();

        d = ( dPlanet/* - radius * 1.01*/ );

        controls.movementSpeed = 0.33 * d;
        controls.update( delta );

        renderer.clear();
        composer.render( delta );
    }
</script>
</body>
</html>